<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Carregando... - BAEFLIX</title>
    <link href="https://i.ibb.co/PGJ87dN5/cineveo-logo-r.png" rel="icon" type="image/png"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0A0A0A;
        }
        .player-wrapper {
            position: relative;
            padding-top: 56.25%; /* Proporção 16:9 */
            height: 0;
            overflow: hidden;
            background-color: #000;
            border-radius: 0.5rem;
        }
        .player-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #E50914;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-black text-gray-300">

<header class="bg-gray-900/50 backdrop-blur-md shadow-lg sticky top-0 z-40 border-b border-gray-800">
    <nav class="container mx-auto px-4 sm:px-6 py-3 flex items-center justify-between gap-4">
        <a aria-label="Página Inicial" href="/index.html">
            <img alt="Logo BAEFLIX" class="h-16 w-auto" src="https://i.ibb.co/XrGt6ymb/Chat-GPT-Image-14-de-ago-de-2025-23-47-40.png"/>
        </a>
    </nav>
</header>

<main class="container mx-auto p-4 md:p-8 max-w-7xl">
    <div class="mb-4">
        <h1 class="text-2xl md:text-4xl font-black text-white mb-4" id="video-title">Carregando informações do filme...</h1>
    </div>
    
    <div id="player-container" class="w-full bg-black rounded-lg shadow-2xl overflow-hidden mb-8">
        <div class="player-wrapper" id="player-wrapper">
            <div class="absolute inset-0 flex items-center justify-center flex-col">
                <div class="loader"></div>
                <p class="mt-4 text-gray-400">Buscando link do stream...</p>
            </div>
        </div>
    </div>
</main>

<script type="module">
    document.addEventListener('DOMContentLoaded', async () => {
        const TMDB_API_KEY = "cf64e357f3a003e17687bb93cb692d6e";

        const titleElement = document.getElementById('video-title');
        const playerWrapper = document.getElementById('player-wrapper');
        const urlParams = new URLSearchParams(window.location.search);
        
        const tmdbId = urlParams.get('tmdbId'); 
        const imdbId = urlParams.get('imdbId'); 

        if (!tmdbId || !imdbId) {
            titleElement.textContent = "Erro: Faltando ID do filme na URL.";
            playerWrapper.innerHTML = `<div class="absolute inset-0 flex items-center justify-center p-4 text-center"><p class="text-red-400">Não foi possível carregar o filme porque as informações necessárias não foram encontradas na URL. Por favor, volte à página inicial e selecione o filme novamente.</p></div>`;
            return;
        }

        try {
            // 1. Busca os detalhes do filme no TMDB para mostrar o título
            const tmdbDetailsResponse = await fetch(`https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${TMDB_API_KEY}&language=pt-BR`);
            const movieDetails = await tmdbDetailsResponse.json();
            if (movieDetails.title) {
                titleElement.textContent = movieDetails.title;
                document.title = `Assistindo: ${movieDetails.title} - BAEFLIX`;
            }

            // 2. Chama a SUA API na Vercel para pegar o link do stream
            const streamApiResponse = await fetch(`/api/stream/movie/${imdbId}`);
            if (!streamApiResponse.ok) {
                throw new Error(`Sua API de stream respondeu com erro: ${streamApiResponse.status}`);
            }
            const streamData = await streamApiResponse.json();

            // 3. Verifica se a API encontrou um link
            if (streamData.streams && streamData.streams.length > 0) {
                const streamInfo = streamData.streams[0];
                const originalStreamUrl = streamInfo.url;

                // 4. PREPARA A URL DO PROXY
                const proxyUrl = new URL('/api/proxy', window.location.origin);
                proxyUrl.searchParams.set('videoUrl', originalStreamUrl);

                if (streamInfo.behaviorHints?.proxyHeaders?.request) {
                    const headers = streamInfo.behaviorHints.proxyHeaders.request;
                    const encodedHeaders = encodeURIComponent(JSON.stringify(headers));
                    proxyUrl.searchParams.set('headers', encodedHeaders);
                }
                
                console.log("URL final do Player (via proxy):", proxyUrl.href);

                // 5. Cria o <iframe> e o coloca no player usando a URL do SEU PROXY
                playerWrapper.innerHTML = `
                    <iframe 
                        id="video-player-iframe" 
                        src="${proxyUrl.href}" 
                        allowfullscreen 
                        allow="autoplay; encrypted-media"
                    ></iframe>
                `;
            } else {
                throw new Error(streamData.error || "Nenhum stream disponível encontrado pela API.");
            }
        } catch (error) {
            console.error("Erro final ao carregar o player:", error);
            titleElement.textContent = "Erro ao carregar o filme";
            playerWrapper.innerHTML = `<div class="absolute inset-0 flex items-center justify-center text-center p-4"><p class="text-red-500">${error.message}</p></div>`;
        }
    });
</script>

</body>
</html>
