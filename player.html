<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Carregando... - BAEFLIX</title>
    <link href="https://i.ibb.co/PGJ87dN5/cineveo-logo-r.png" rel="icon" type="image/png"/>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0A0A0A; }
        :root { --plyr-color-main: #E50914; --plyr-font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #4A4A4A; border-top: 4px solid #E50914; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-black text-gray-300">
    <header class="bg-gray-900/50 backdrop-blur-md shadow-lg sticky top-0 z-40 border-b border-gray-800">
        <nav class="container mx-auto px-4 sm:px-6 py-3 flex items-center justify-between gap-4">
            <a aria-label="Página Inicial" href="/index.html"> <img alt="Logo BAEFLIX" class="h-16 w-auto" src="https://i.ibb.co/XrGt6ymb/Chat-GPT-Image-14-de-ago-de-2025-23-47-40.png"/> </a>
        </nav>
    </header>
    <main class="container mx-auto p-4 md:p-8">
        <div class="mb-4">
            <h1 class="text-2xl md:text-4xl font-black text-white mb-2" id="video-title">Carregando...</h1>
            <p class="text-gray-400" id="video-description"></p>
        </div>
        <div id="player-container" class="w-full bg-black rounded-lg shadow-2xl overflow-hidden mb-6">
            <div class="aspect-video w-full">
                 <video id="player" playsinline controls></video>
            </div>
        </div>
        <div id="quality-selector-container">
            <h2 class="text-xl font-bold text-white mb-3">Opções de Áudio:</h2>
            <div id="quality-buttons" class="flex flex-wrap gap-3"></div>
        </div>
    </main>
    <script type="module">
        const TMDB_API_KEY = "cf64e357f3a003e17687bb93cb692d6e";
        const STREAM_API_URLS = {
            movie: ["https://baby-beamup.club/stream/movie", "https://da5f663b4690-skyflixfork.baby-beamup.club/stream/movie"],
            tv: ["https://baby-beamup.club/stream/series", "https://da5f663b4690-skyflixfork.baby-beamup.club/stream/series"]
        };
        const CORS_PROXY = "https://corsproxy.io/?";

        const titleElement = document.getElementById('video-title');
        const descriptionElement = document.getElementById('video-description');
        const playerContainer = document.getElementById('player-container');
        const qualityButtons = document.getElementById('quality-buttons');
        
        let player;

        async function fetchStreamData(url) {
            for (const baseUrl of url) {
                try {
                    const response = await fetch(CORS_PROXY + encodeURIComponent(baseUrl));
                    if (response.ok) {
                        const data = await response.json();
                        if (data.streams && data.streams.length > 0) return data.streams;
                    }
                } catch (e) { console.warn(`Falha ao buscar de ${baseUrl}`, e); }
            }
            return null;
        }

        function loadStreamIntoPlayer(streamUrl) {
            if (player) {
                player.source = {
                    type: 'video',
                    sources: [{ src: streamUrl, type: 'video/mp4' }],
                };
                player.play();
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const mediaId = urlParams.get('id');
            const season = urlParams.get('s');
            const episode = urlParams.get('e');
            const type = season ? 'tv' : 'movie'; // Se tem temporada, é uma série

            if (!mediaId) {
                titleElement.textContent = "Erro: ID não encontrado.";
                return;
            }

            try {
                // Inicia o player vazio
                player = new Plyr('#player');
                
                // Busca detalhes do TMDB
                const detailsUrl = `https://api.themoviedb.org/3/${type}/${mediaId}${type === 'tv' ? `/season/${season}/episode/${episode}` : ''}?api_key=${TMDB_API_KEY}&language=pt-BR`;
                const detailsResponse = await fetch(detailsUrl);
                const detailsData = await detailsResponse.json();
                
                const title = detailsData.title || detailsData.name;
                titleElement.textContent = title;
                descriptionElement.textContent = type === 'tv' ? `Temporada ${season}, Episódio ${episode}` : '';
                document.title = `Assistindo: ${title} - BAEFLIX`;

                // Busca o IMDb ID
                const externalIdsUrl = `https://api.themoviedb.org/3/${type}/${mediaId}/external_ids?api_key=${TMDB_API_KEY}`;
                const idsResponse = await fetch(externalIdsUrl);
                const idsData = await idsResponse.json();
                const imdbId = idsData.imdb_id;
                if (!imdbId) throw new Error("IMDb ID não encontrado.");

                // Monta as URLs de busca de stream
                const streamUrlsToTry = STREAM_API_URLS[type].map(baseUrl => 
                    type === 'tv' ? `${baseUrl}/${imdbId}:${season}:${episode}.json` : `${baseUrl}/${imdbId}.json`
                );
                
                // Busca os streams
                const streams = await fetchStreamData(streamUrlsToTry);
                if (!streams) throw new Error("Nenhum stream encontrado.");

                qualityButtons.innerHTML = '';
                streams.forEach((stream, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'bg-gray-700 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition-colors';
                    btn.textContent = stream.description || stream.name || `Opção ${index + 1}`;
                    btn.onclick = () => {
                        // Remove a classe de 'ativo' de outros botões
                        document.querySelectorAll('#quality-buttons button').forEach(b => b.classList.remove('bg-red-600'));
                        // Adiciona a classe no botão clicado
                        btn.classList.add('bg-red-600');
                        loadStreamIntoPlayer(stream.url);
                    };
                    qualityButtons.appendChild(btn);
                });
                
                // Carrega o primeiro stream por padrão e o marca como ativo
                if (qualityButtons.firstChild) {
                    qualityButtons.firstChild.click();
                }
                
            } catch (error) {
                console.error("Erro ao carregar o player:", error);
                titleElement.textContent = "Erro ao carregar";
                descriptionElement.textContent = error.message;
            }
        });
    </script>
</body>
</html>
